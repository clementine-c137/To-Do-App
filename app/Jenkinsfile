pipeline {
  agent any
  /*environment {
    DOCKER_PWD = credentials('docker-pwd')
  }*/
  stages {
    stage('Build-img') {
      steps {
        sh 'ls -l'
        sh 'pwd'
        sh 'cd app && docker build -t tbancila/tali-app:latest .'
      }
    }
    stage('Push-img') {
      steps {
        //withCredentials([string(credentialsId: 'docker-pwd', variable: 'password')]) 
        sh 'docker login -u "tbancila" -p "SQAPmjyu20" docker.io'
        sh 'docker push tbancila/tali-app:latest'
      }
    }
    stage('Deploy') {
      steps {
        sh 'ls -la'
        sh 'ssh -i "./Tali-ssh.pem" ec2-user@10.0.3.239 -o stricthostkeychecking=no "sudo docker login -u "tbancila" -p "SQAPmjyu20" docker.io"' 
        sh 'ssh -i "./Tali-ssh.pem" ec2-user@10.0.3.239 "sudo docker rm -f app"' 
        sh 'ssh -i "./Tali-ssh.pem" ec2-user@10.0.3.239 "sudo docker run --name app -d -p 3000:3000 tbancila/tali-app:latest"' 

      }
    }
  }
}
